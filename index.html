<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.0/themes/base/jquery-ui.css">

    <link href="https://maps-sdk.trimblemaps.com/v3/trimblemaps-3.9.0.css" rel="stylesheet">
    <script src=https://maps-sdk.trimblemaps.com/v3/trimblemaps-3.9.0.js></script>
<!--    <script src="https://maps-sdk.trimblemaps.com/v1/alkmaps-1.2.3.js"></script>-->

    <script src=https://npmcdn.com/@turf/turf/turf.min.js type="text/javascript"></script>
    <script src=https://cdnjs.cloudflare.com/ajax/libs/mapbox-polyline/1.1.1/polyline.js type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.14.0/jquery-ui.js"></script>
    <style>

        #pick-on-map {
            top: 0px;
            position: absolute;
            background: #fff;
            padding: 8px;
            font-family: 'Open Sans', sans-serif;
        }

            #pick-on-map span {
                color: #576571;
                line-height: 32px;
                display: inline-block;
                vertical-align: bottom;
            }

        #hriStatus {
            position: absolute;
            top: 152px;
            text-align: center;
            width: 800px;
        }

        #myMap {
            position: absolute;
            left: 32px;
            top: 32px;
            bottom: 0;
            width: 100%;
        }

        #geocodeCtrl .button {
            background-image: url('https://developer.trimblemaps.com/maps-sdk/img/marker_blue.png');
            height: 22px !important;
            width: 22px !important;
            border: 1px solid transparent;
            display: inline-block;
        }

        #geocodeCtrl .active {
            background-color: #9fb7c8;
            border: 1px solid #7f92a0;
        }

        #geocodeCtrl .inactive {
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
        }

        #crossingStatus {
            position: absolute;
            top: 768px;
        }

        #distanceToHRI {
            position: absolute;
            top: 768px;
            bottom: 0;
            width: 100%;
        }

        #otherPages {
            position: absolute;
            top: 828px;
            bottom: 0;
            width: 100%;
        }

        .marker-icon {
            background-image: url('https://developer.trimblemaps.com/maps-sdk/img/marker_blue.png');
            background-repeat: no-repeat;
            width: 21px;
            height: 25px;
            cursor: pointer;
        }
    </style>

</head>
<body>

    <div id="myMap"></div>
    <div id="MouseLatLon"></div>

    <button onclick="showPHPInfo();">php info</button>

    <div id="hri-information" class="hri-information" title="HRI Information" style="display: none;">
        <table>
            <tr>
                <td>
                    <table style="width: 256px">
                        <tr><td>US DOT No:<span id="CrossingID"</span></td></tr>
                        <tr><td>Status: <span id="Status"></span></td></tr>
                        <tr><td>Comms: <span id="Comms"></span></td></tr>
                        <tr><td>City: <span id="CityName"</span></td></tr>
                        <tr><td>Street: <span id="Street"></span></td></tr>
                        <tr><td>County: <span id="CountyName"</span></td></tr>
                        <tr><td>State: <span id="StateName"</span></td></tr>
                        <tr><td>Rail Name: <span id="Railroad"></span></td></tr>
                    </table>
                    <table style="width: 256px">
                        <tr>
                            <td><button type="button" onclick="showMoreInformation();">More Info</button></td>
                            <td><button type="button" onclick="hideInformation();">Close</button></td>
                        </tr>
                    </table>
                </td>
                <td>
                    <div style="vertical-align:top; margin-bottom:32px; margin-top:32px">
                        <button type="button" onclick="activateDeactivateHRI();" style="margin:0,0,64px,0; width:96px">Toggle Train</br>Detection</br>On/Off</button>
                    </div>
                    <div style="vertical-align:top; margin-bottom:64px">
                        <button type="button" onclick="enableDisableOperational();" style="margin:64px,0,0,0; width:96px">Toggle Comms</br>On/Off</button>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <div id="hri-more-information" class="hri-more-information" title="HRI Information" style="display: none;">
        <table>
            <tr>
                <td>
                    <table style="width: 256px">
                        <tr><td>US DOT No:<span id="more-CrossingID"</span></td></tr>
                        <tr><td>Status: <span id="more-Status"></span></td></tr>
                        <tr><td>Comms: <span id="more-Comms"></span></td></tr>
                        <tr><td>City: <span id="more-CityName"</span></td></tr>
                        <tr><td>Street: <span id="more-Street"></span></td></tr>
                        <tr><td>County: <span id="more-CountyName"</span></td></tr>
                        <tr><td>County: <span id="more-StateName"</span></td></tr>
                        <tr><td>Rail Name: <span id="more-Railroad"></span></td></tr>
                    </table>
                    <table style="width: 256px">
                        <tr>
                            <td><button type="button" onclick="hideMoreInformation();">Close</button></td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </div>
    <script>

        TrimbleMaps.APIKey = "7E27C13016099E47A48B466C0EC38AF2";

        var origin = [-81.71896370494375, 30.28618658831364];
        var hri621223F = ['621223f', 'Jacksonville, FL', 'Franklin', 'San Juan Ave', [-81.720559, 30.282196]];
        var hri621221S = ['621221S', 'Jacksonville, FL', 'Franklin', 'St. Johns Ave', [-81.7206070, 30.2885320]];
        var hri271824W = ['271824W', 'Jacksonville, FL', 'Franklin', 'Sunbeam Rd', [-81.5787700, 30.2060770]];
        var hri621275X = ['621275X', 'Jacksonville, FL', 'Franklin', 'S. Edgewood Ave', [-81.7308415, 30.3269015]];

        var hriPoints = [hri621223F, hri621221S, hri271824W, hri621275X];

        var hriLatitude = origin[1];
        var hriLongitude = origin[0];

        var map = new TrimbleMaps.Map({
            container: "myMap",
            center: new TrimbleMaps.LngLat(hriLongitude, hriLatitude),
            /*
                style: TrimbleMaps.Common.Style.SATELLITE,
            */
            style: TrimbleMaps.Common.Style.TRANSPORTATION,
            zoom: 15,
            pitch: 10,
            antialias: true
        });

        var trimbleMapPopup = null;
        var trimbleMapPopupMore = null;
        var activeHRI = null;
        var activeHRILayer = null;

        map.on('load', function () {
            //fdocument.getElementById('iconDiv').classList.toggle('active');
            //window.chrome.webview.addEventListener("message", function () { alert(`message`); });
            setupMap();
        });

        map.on('mousemove', function (e) {
            /*
                        document.getElementById("MouseLatLon").innerHTML =
                                `LAT: ` + e.lngLat.lat + ` LNG: ` + e.lngLat.lng + `</br>` +
                                    map.transform.center.lat + `,` + map.transform.center.lng + `</br>` +
                                    map.transform.tileZoom;
            */
        });

        function setupMap() {

            map.loadImage('/rrNominal.png', function (error, image) {
                map.addImage(`rrIcon`, image);
            });

            map.loadImage('/rrActive.png', function (error, image) {
                map.addImage(`rrIconActive`, image);
            });

            for ( k = 0; k < 4; k++ ) {

                var props = `[` +
                    `["hri-info-dotno","` + hriPoints[k][0] + `"],` +
                    `["hri-operational","1"],` +
                    `["hri-active","0"]]`;

                rrCrossingPoint = {
                    type: 'FeatureCollection', features: [{
                        type: 'Feature',
                        properties: {
                            'icon': `rrIcon`,
                            'hriData': props
                        },
                        geometry: { type: 'Point', coordinates: [hriPoints[k][4][0], hriPoints[k][4][1]] },
                    }]
                }

                rrActivePoint = {
                    type: 'FeatureCollection', features: [{
                        type: 'Feature',
                        properties: {
                            'icon': `rrIconActive`,
                            'hriData': props
                        },
                        geometry: { type: 'Point', coordinates: [hriPoints[k][4][0], hriPoints[k][4][1]] },
                    }]
                }

                map.addSource(`railroad_crossings` + hriPoints[k][0], { type: 'geojson', data: rrCrossingPoint });
                map.addSource(`active_crossings` + hriPoints[k][0], { type: 'geojson', data: rrActivePoint });

                map.addLayer({
                    'id': `railroad_crossings` + hriPoints[k][0],
                    'type': 'symbol',
                    'source': `railroad_crossings` + hriPoints[k][0],
                    'layout': {
                        'icon-image': ['get', 'icon'],
                        'icon-allow-overlap': true
                    }
                });

                map.on('mouseenter', `railroad_crossings` + hriPoints[k][0], function () {
                    if (trimbleMapPopup)
                        return;
                    map.getCanvas().style.cursor = 'pointer';
                });

                map.on('mouseleave', `railroad_crossings` + hriPoints[k][0], function () {
                    map.getCanvas().style.cursor = '';
                });

                map.on('click', `railroad_crossings` + hriPoints[k][0], function (e) {
                    if (trimbleMapPopup)
                        return;
                    activeHRI = map.queryRenderedFeatures(e.point)[0];
                    activeHRILayer = activeHRI.layer.id;
                    showInformation();
                });

            }

        }

        function activeIndex(hriData) {
            return hriData.length - 1;
        }

        function operationalIndex(hriData) {
            return hriData.length - 2;
        }

        function activateDeactivateHRI() {

            map.removeLayer(activeHRILayer);

            var hriData = JSON.parse(activeHRI.properties.hriData);

            if ( "0" == hriData[activeIndex(hriData)][1] ) {

                map.addLayer({
                    'id': `active_crossings` + hriData[0][1],
                    'type': 'symbol',
                    'source': `active_crossings` + hriData[0][1],
                    'layout': {
                        'icon-image': ['get', 'icon'],
                        'icon-allow-overlap': true
                    }
                });
                activeHRILayer = `active_crossings` + hriData[0][1];

                hriData[activeIndex(hriData)][1] = "1";

            } else {

                activeHRI.layer = map.addLayer({
                    'id': `railroad_crossings` + hriData[0][1],
                    'type': 'symbol',
                    'source': `railroad_crossings` + hriData[0][1],
                    'layout': {
                        'icon-image': ['get', 'icon'],
                        'icon-allow-overlap': true
                    }
                });
                activeHRILayer = `railroad_crossings` + hriData[0][1];

                hriData[activeIndex(hriData)][1] = "0";

            }

            activeHRI.properties.hriData = JSON.stringify(hriData);

            map.on('mouseenter', activeHRILayer, function () {
                if (trimbleMapPopup)
                    return;
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', activeHRILayer, function () {
                map.getCanvas().style.cursor = '';
            });

            map.on('click', activeHRILayer, function (e) {
                if (trimbleMapPopup)
                    return;
                activeHRI = map.queryRenderedFeatures(e.point)[0];
                activeHRILayer = activeHRI.layer.id;
                showInformation();
            });

            flashHRI();
            monitorHRI();

            const xhttp = new XMLHttpRequest();
            xhttp.onload = function () {
            }
            xhttp.open("GET", "setHRIValue.php?crossingID=" + hriData[0][1] + "&field=PreemptionStatus&status=" + hriData[activeIndex(hriData)][1]);
            xhttp.send();

        }


        function enableDisableOperational() {

            var hriData = JSON.parse(activeHRI.properties.hriData);

            const xhttp = new XMLHttpRequest();
            xhttp.onload = function () {
            }
            xhttp.open("GET", "setHRIValue.php?crossingID=" + hriData[0][1] + "&field=RBSOperational&status=" + hriData[operationalIndex(hriData)][1]);
            xhttp.send();
        }


        function flashHRI() {
            var hriData = JSON.parse(activeHRI.properties.hriData);
            map.setLayoutProperty(activeHRILayer, 'visibility', 'none');
            setTimeout(function () {
                map.setLayoutProperty(activeHRILayer, 'visibility', 'visible');
                if ("1" == hriData[activeIndex(hriData)][1] )
                    setTimeout(function () { flashHRI(); }, 500);
            }, 500);
        }


        function monitorHRI() {

if ( ! activeHRI )
return;
            var hriData = JSON.parse(activeHRI.properties.hriData);

            getInformation(hriData[0][1], function (info) {
                var crossingData = JSON.parse(info);
                for ( k = 0; k < crossingData.length; k++ ) {
                    var elem = document.getElementById(crossingData[k][0]);
                    if (elem)
                        elem.innerHTML = crossingData[k][1];
                    elem = document.getElementById('more-' + crossingData[k][0]);
                    if (elem)
                        elem.innerHTML = crossingData[k][1];
                }
            });

            setTimeout(function () {
                //if ("1" == hriData[hriData.length - 1][1])
                    setTimeout(function () { monitorHRI(); }, 1000);
            }, 1000);

        }


        function getInformation(hriID,callback) {
            const xhttp = new XMLHttpRequest();
            xhttp.onload = function () {
                callback(this.responseText);
            }
            xhttp.open("GET", "getCrossingInfo.php?crossingID=" + hriID);
            xhttp.send();
        }


        function showInformation() {
            hideInformation();
            getInformation(JSON.parse(activeHRI.properties.hriData)[0][1],function(info) {
                var crossingData = JSON.parse(info);
                for ( k = 0; k < crossingData.length; k++ ) {
                    var elem = document.getElementById(crossingData[k][0]);
                    if (elem)
                        elem.innerHTML = crossingData[k][1];
                }
                var dialogElem = document.getElementById(`hri-information`);
                trimbleMapPopup = new TrimbleMaps.Popup({ closeOnClick: false })
                    .setLngLat(activeHRI.geometry.coordinates.slice())
                    .setHTML(dialogElem.innerHTML)
                    .setMaxWidth(1024)
                    .addTo(map);
                monitorHRI();
            });
            return;
        }


        function showMoreInformation() {
            hideMoreInformation();
            getInformation(JSON.parse(activeHRI.properties.hriData)[0][1], function (info) {
                var crossingData = JSON.parse(info);
                for ( k = 0; k < crossingData.length; k++ ) {
                    var elem = document.getElementById('more-' + crossingData[k][0]);
                    if ( elem )
                        elem.innerHTML = crossingData[k][1];
                }
                var dialogElem = document.getElementById(`hri-more-information`);
                trimbleMapPopupMore = new TrimbleMaps.Popup({ closeOnClick: false, offset: [256, 128] })
                    .setLngLat(activeHRI.geometry.coordinates.slice())
                    .setHTML(dialogElem.innerHTML)
                    .setMaxWidth(1024)
                    .addTo(map);
            });;
            return;
        }


        function hideInformation() {
            if (trimbleMapPopup)
                trimbleMapPopup.remove();
            trimbleMapPopup = null;
            hideMoreInformation();
        }


        function hideMoreInformation() {
            if (trimbleMapPopupMore)
                trimbleMapPopupMore.remove();
            trimbleMapPopupMore = null;
        }


        function showPHPInfo() {
            window.location.href = "/db2.php";
        }
    </script>

</body>
</html>